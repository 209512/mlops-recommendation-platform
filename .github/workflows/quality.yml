name: Code Quality & Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # 매주 월요일 새벽 2시
  workflow_dispatch:

jobs:
  comprehensive-analysis:
    runs-on: ubuntu-latest
    env:
      # 테스트용 환경 변수
      ENVIRONMENT: "test"
      DATABASE_URL: "sqlite+aiosqlite:///:memory:"
      REDIS_URL: "redis://localhost:6379/0"
      MLFLOW_TRACKING_URI: "http://localhost:5001"
      MLFLOW_EXPERIMENT_NAME: "quality-test-experiment"
      SECRET_KEY: "test-secret-key-for-quality-only"
      POSTGRES_PASSWORD: "test-password"
      AWS_ACCESS_KEY_ID: "test-key"
      AWS_SECRET_ACCESS_KEY: "test-secret"
      AWS_REGION: "ap-northeast-2"
      ECR_REGISTRY: "test-account.dkr.ecr.ap-northeast-2.amazonaws.com"
      SONAR_HOST_URL: "http://localhost:9000"
      SONAR_TOKEN: "test-sonar-token"

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up uv
      uses: astral-sh/setup-uv@v2

    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies and deep scan tools
      run: uv pip install -e ".[dev]" semgrep radon mccabe

    - name: Add Venv Binaries to PATH
      run: echo "$(pwd)/.venv/bin" >> $GITHUB_PATH

    - name: Run comprehensive MyPy (Strict Check)
      run: |
        mypy \
          --no-strict-optional \
          --ignore-missing-imports \
          --disallow-untyped-defs=false \
          app/

    - name: Run Ruff with all checks
      run: |
        ruff check . --select ALL
        ruff format --check .

    - name: Run Pylint
      run: pylint app/ --output-format=text > pylint-report.txt || true

    - name: Run tests with detailed coverage
      run: |
        pytest tests/ --cov=app --cov-report=xml --cov-report=html --cov-fail-under=80
        coverage xml
        coverage html

    - name: Run Security Scans (Bandit, Safety, Semgrep)
      run: |
        bandit -r app/ -f json -o bandit-report.json -ll
        safety check --json --output safety-report.json
        semgrep --config=auto --json --output=semgrep-report.json app/ || true

    - name: Check for complex code (Radon)
      run: radon cc app/ --min B --exclude "*/__init__.py" > radon-cc-report.txt

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v2.1.0
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    - name: Upload all reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports
        path: |
          coverage.xml
          htmlcov/
          bandit-report.json
          safety-report.json
          semgrep-report.json
          pylint-report.txt
          radon-cc-report.txt